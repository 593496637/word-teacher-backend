name: ğŸš€ Deploy Mastra Backend to Cloudflare Workers

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  # æ‰‹åŠ¨è§¦å‘åŠŸèƒ½
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging
      force_deploy:
        description: 'Force deployment even on PR'
        required: false
        default: false
        type: boolean

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: ğŸ—ï¸ Build and Deploy Mastra Backend
    
    steps:
      # ğŸ“¥ æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
          
      # ğŸŸ¢ è®¾ç½® Node.jsï¼ˆå›ºå®šç‰ˆæœ¬ä»¥ç¡®ä¿å…¼å®¹æ€§ï¼‰
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: word-teacher-backend/package-lock.json
          
      # ğŸ“¦ æ¸…ç†å¹¶å®‰è£…ä¾èµ–
      - name: ğŸ“¦ Clean install dependencies
        working-directory: word-teacher-backend
        run: |
          echo "æ£€æŸ¥é¡¹ç›®ç»“æ„ï¼š"
          ls -la
          echo "ä½¿ç”¨npmå®‰è£…ä¾èµ–ï¼š"
          npm ci
          echo "éªŒè¯å®‰è£…ç»“æœï¼š"
          ls -la package*
        
      # ğŸ”§ ç±»å‹æ£€æŸ¥
      - name: ğŸ”§ Type check
        working-directory: word-teacher-backend
        run: npm run type-check
        
      # ğŸ—ï¸ Mastra æ„å»º
      - name: ğŸ—ï¸ Build Mastra Application
        id: mastra_build
        working-directory: word-teacher-backend
        run: |
          echo "=== å‡†å¤‡ Mastra æ„å»º ==="
          echo "æ£€æŸ¥ Node.js ç¯å¢ƒï¼š"
          node --version
          npm --version
          echo "å¼€å§‹ Mastra æ„å»º..."
          npm run build
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          NODE_ENV: production
          NODE_OPTIONS: "--experimental-global-webcrypto"
          
      # ğŸ“‹ éªŒè¯æ„å»ºè¾“å‡º
      - name: ğŸ“‹ Verify build output
        working-directory: word-teacher-backend
        run: |
          echo "=== æ„å»ºåçš„é¡¹ç›®ç»“æ„ ==="
          ls -la
          echo ""
          echo "=== æ£€æŸ¥ Mastra æ„å»ºè¾“å‡º ==="
          if [ -d ".mastra/output" ]; then
            echo "âœ… .mastra/output ç›®å½•å­˜åœ¨"
            ls -la .mastra/output/
            echo ""
            echo "=== éªŒè¯å…³é”®æ–‡ä»¶ ==="
            if [ -f ".mastra/output/index.mjs" ]; then
              echo "âœ… å…¥å£æ–‡ä»¶å­˜åœ¨: .mastra/output/index.mjs"
              echo "æ–‡ä»¶å¤§å°: $(du -h .mastra/output/index.mjs | cut -f1)"
            else
              echo "âŒ å…¥å£æ–‡ä»¶ä¸å­˜åœ¨: .mastra/output/index.mjs"
              exit 1
            fi
          else
            echo "âŒ .mastra/output ç›®å½•ä¸å­˜åœ¨"
            echo "å½“å‰ .mastra ç›®å½•å†…å®¹ï¼š"
            ls -la .mastra/ || echo "âŒ .mastra ç›®å½•ä¹Ÿä¸å­˜åœ¨"
            exit 1
          fi
          
      # ğŸ“„ ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ğŸ“„ Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mastra-build-output
          path: |
            word-teacher-backend/.mastra/output/
          retention-days: 7
          
      # ğŸš€ ä¸»è¦éƒ¨ç½²æ–¹æ¡ˆï¼šä½¿ç”¨ Mastra CLI
      - name: ğŸš€ Deploy using Mastra CLI
        id: mastra_deploy
        continue-on-error: true
        working-directory: word-teacher-backend
        if: |
          (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
          (github.event_name == 'workflow_dispatch') ||
          (github.event_name == 'workflow_dispatch' && inputs.force_deploy == 'true')
        run: |
          echo "ä½¿ç”¨ Mastra CLI éƒ¨ç½²åˆ° Cloudflare Workers..."
          echo "éªŒè¯ç¯å¢ƒå˜é‡ï¼š"
          echo "CLOUDFLARE_ACCOUNT_ID: ${CLOUDFLARE_ACCOUNT_ID:0:8}..."
          echo "CLOUDFLARE_API_TOKEN: ${CLOUDFLARE_API_TOKEN:0:8}..."
          echo "OPENAI_API_KEY: ${OPENAI_API_KEY:0:8}..."
          echo "éªŒè¯æ„å»ºè¾“å‡ºï¼š"
          ls -la .mastra/output/
          echo "å¼€å§‹éƒ¨ç½²..."
          # å®‰è£… mastra CLI
          npm install -g mastra
          # ä½¿ç”¨ mastra deploy
          mastra deploy
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          NODE_ENV: ${{ inputs.environment || 'production' }}
          
      # ğŸ”§ å¤‡ç”¨éƒ¨ç½²æ–¹æ¡ˆï¼šä½¿ç”¨ Wrangler
      - name: ğŸ”§ Backup Deploy with Wrangler
        working-directory: word-teacher-backend
        if: |
          (steps.mastra_deploy.outcome != 'success') && (
            (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
            (github.event_name == 'workflow_dispatch') ||
            (github.event_name == 'workflow_dispatch' && inputs.force_deploy == 'true')
          )
        run: |
          echo "Mastra éƒ¨ç½²å¤±è´¥ï¼Œä½¿ç”¨ Wrangler å¤‡ç”¨æ–¹æ¡ˆ..."
          echo "å®‰è£… Wrangler..."
          npm install -g wrangler@latest
          echo "éªŒè¯ Wrangler ç‰ˆæœ¬:"
          wrangler --version
          echo "éªŒè¯ç¯å¢ƒå˜é‡ï¼š"
          echo "CLOUDFLARE_ACCOUNT_ID: ${CLOUDFLARE_ACCOUNT_ID}"
          echo "éªŒè¯æ„å»ºæ–‡ä»¶..."
          if [ -f ".mastra/output/index.mjs" ]; then
            echo "âœ… æ„å»ºæ–‡ä»¶å­˜åœ¨ï¼Œå¼€å§‹éƒ¨ç½²..."
            if [ -f "wrangler.toml" ]; then
              echo "éªŒè¯ wrangler.toml é…ç½®:"
              cat wrangler.toml
              echo ""
              echo "ä½¿ç”¨ Wrangler éƒ¨ç½² Worker..."
              # ç¡®ä¿éƒ¨ç½²åˆ°æ­£ç¡®çš„ç¯å¢ƒ
              wrangler deploy --config wrangler.toml --env production
            else
              echo "âš ï¸ wrangler.toml ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®éƒ¨ç½²..."
              wrangler deploy --name word-teacher-backend --main .mastra/output/index.mjs --compatibility-date 2024-01-01 --compatibility-flags nodejs_compat
            fi
            echo ""
            echo "âœ… Worker éƒ¨ç½²æˆåŠŸï¼"
            echo ""
            echo "âš ï¸  é‡è¦æé†’ï¼š"
            echo "Worker å·²éƒ¨ç½²ï¼Œä½†éœ€è¦æ‰‹åŠ¨åœ¨ Cloudflare Dashboard ä¸­è®¾ç½®ç¯å¢ƒå˜é‡ï¼š"
            echo "1. è®¿é—®: https://dash.cloudflare.com"
            echo "2. è¿›å…¥ Workers & Pages"
            echo "3. é€‰æ‹© 'word-teacher-backend'"
            echo "4. è¿›å…¥ Settings -> Variables"
            echo "5. æ·»åŠ ç¯å¢ƒå˜é‡: OPENAI_API_KEY"
          else
            echo "âŒ æ‰¾ä¸åˆ°æ„å»ºæ–‡ä»¶ï¼Œæ— æ³•éƒ¨ç½²"
            exit 1
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          
      # ğŸ” éªŒè¯éƒ¨ç½²ç»“æœ
      - name: ğŸ” Verify Deployment
        if: |
          (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
          (github.event_name == 'workflow_dispatch')
        run: |
          echo "ğŸ” éªŒè¯éƒ¨ç½²ç»“æœ..."
          echo "æµ‹è¯• Worker æ˜¯å¦å¯è®¿é—®..."
          # ç­‰å¾…å‡ ç§’è®©éƒ¨ç½²ç”Ÿæ•ˆ
          sleep 10
          # å°è¯•è®¿é—® Worker
          echo "å°è¯•è®¿é—® Worker..."
          if curl -f --max-time 30 "https://word-teacher-backend.$(echo $CLOUDFLARE_ACCOUNT_ID | cut -c1-8).workers.dev" > /dev/null 2>&1; then
            echo "âœ… Worker å¯è®¿é—®ï¼"
          else
            echo "âš ï¸  Worker å¯èƒ½è¿˜åœ¨éƒ¨ç½²ä¸­ï¼Œæˆ–è€…éœ€è¦æ‰‹åŠ¨æ£€æŸ¥"
          fi
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          
      # âœ… éƒ¨ç½²æˆåŠŸé€šçŸ¥
      - name: âœ… Deployment Success
        if: |
          success() && (
            (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
            (github.event_name == 'workflow_dispatch')
          )
        run: |
          echo "ğŸ‰ Worker éƒ¨ç½²æˆåŠŸï¼"
          echo ""
          echo "ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œï¼š"
          echo "1. æ£€æŸ¥ Cloudflare Dashboard:"
          echo "   https://dash.cloudflare.com â†’ Workers & Pages"
          echo ""
          echo "2. å¦‚æœçœ‹åˆ° 'word-teacher-backend' é¡¹ç›®ï¼š"
          echo "   âœ… éƒ¨ç½²æˆåŠŸï¼ç‚¹å‡»è¿›å…¥é¡¹ç›®"
          echo ""
          echo "3. è®¾ç½®ç¯å¢ƒå˜é‡:"
          echo "   Settings â†’ Variables â†’ Add variable"
          echo "   åç§°: OPENAI_API_KEY"
          echo "   å€¼: ä½ çš„_openai_api_key"
          echo "   é€‰æ‹©: Encrypt"
          echo "   ç‚¹å‡»: Save and Deploy"
          echo ""
          echo "4. æµ‹è¯• API:"
          echo "   ğŸŒ Worker URL: https://word-teacher-backend.ä½ çš„è´¦æˆ·å.workers.dev"
          echo "   ğŸ”— API ç«¯ç‚¹: https://word-teacher-backend.ä½ çš„è´¦æˆ·å.workers.dev/api/agents/wordTeacher"
          echo ""
          echo "å¦‚æœåœ¨ Dashboard ä¸­æ²¡æœ‰çœ‹åˆ°é¡¹ç›®ï¼Œè¯·é‡æ–°è¿è¡Œéƒ¨ç½²æˆ–æŸ¥çœ‹é”™è¯¯æ—¥å¿—ã€‚"
          
      # âŒ éƒ¨ç½²å¤±è´¥é€šçŸ¥
      - name: âŒ Deployment Failed
        if: |
          failure() && (
            (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
            (github.event_name == 'workflow_dispatch')
          )
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
          echo "ğŸ” è¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š"
          echo "1. Cloudflare API Token æƒé™æ˜¯å¦è¶³å¤Ÿ"
          echo "2. Account ID æ˜¯å¦æ­£ç¡®è®¾ç½®åœ¨ GitHub Secrets ä¸­"
          echo "3. æ„å»ºè¿‡ç¨‹æ˜¯å¦æˆåŠŸå®Œæˆ"
          echo "4. æŸ¥çœ‹ä¸Šé¢çš„é”™è¯¯æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
          echo ""
          echo "ğŸ’¡ GitHub Secrets æ£€æŸ¥æ¸…å•ï¼š"
          echo "- CLOUDFLARE_API_TOKEN: å¿…éœ€"
          echo "- CLOUDFLARE_ACCOUNT_ID: å¿…éœ€ (ä» Dashboard è·å–)"
          echo "- OPENAI_API_KEY: å¿…éœ€"
          echo ""
          echo "ğŸ”§ é‡æ–°åˆ›å»º API Token:"
          echo "https://dash.cloudflare.com/profile/api-tokens"